#!/usr/bin/env raku
use v6.d;

use Graph::RandomMaze;
use Graph;
use JSON::Fast;

my %*SUB-MAIN-OPTS = :named-anywhere;

#-----------------------------------------------------------

#| Generates random mazes and exports to SVG, JSON, or Raku code or code files.
sub MAIN(Int $rows,                           #= Walls grid graph rows.
         Int $columns,                        #= Walls grid graph columns.
         Str :$type = 'rectangular',          #= Type of graph grid to use. (One of 'rectangular' or 'hexagonal'.)
         Str :t(:format(:$to)) = 'Whatever',  #= Format to convert to. (One of 'json', 'raku', 'svg', 'wl', 'Whatever'.)
         Str :props(:$properties) = 'walls',  #= Properties separated by comma.
         Str :o(:$output) = '',               #= Output file; if an empty string then the result is printed to stdout.
         Str :$engine = 'neato',              #= Graphviz graph layout engine.
         ) {

    my $prop-spec = $properties;
    if $properties ~~ Str:D && $properties.contains(',') {
        $prop-spec = $properties.split(/ \s* ',' \s* /);
    }

    my $res = random-maze(:$rows, :$columns, :$type, properties => $prop-spec);

    my $export = do given $to.lc {
        when 'raku' { $res.raku }

        when 'wl' {
            $res ~~ Graph:D ?? $res.wl !! $res
        }

        when 'svg' { display-maze($res, :$engine) }

        when 'json' {
            if $res ~~ Graph:D {
                to-json($res.edge(:dataset))
            } elsif $res ~~ Map:D {
                my %converted = $res.map(-> $k, $v {
                    $k => ($v ~~ Graph:D ?? $v.edge(:dataset) !! $v)
                }).Hash;
                to-json(%converted)
            } else {
                to-json($res)
            }
        }

        default { $res }
    };

    my $content = do given $export {
        when Blob { $_ }
        when Str  { $_ }
        default   { $_.raku }
    };

    if $output.chars > 0 {
        spurt($output, $content);
    } else {
        say $content;
    }
}

